{% extends 'stocks/base.html' %}
{% load render_table from django_tables2 %}
{% load django_bootstrap5 %}

{% block title %}Stock List - Stock Picker{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">ðŸ“‹ Stock Analysis Results</h1>
    
    {% if latest_date %}
        <div class="alert alert-info">
            <strong>Data Date:</strong> {{ latest_date|date:"F d, Y" }}
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group me-2" role="group">
                        <a href="?filter=all" class="btn btn-{% if current_filter == 'all' %}primary{% else %}outline-primary{% endif %}">
                            All Stocks ({{ total_stocks }})
                        </a>
                        <a href="?filter=passing" class="btn btn-{% if current_filter == 'passing' %}success{% else %}outline-success{% endif %}">
                            Passing ({{ passing_count }})
                        </a>
                        <a href="?filter=vcp" class="btn btn-{% if current_filter == 'vcp' %}info{% else %}outline-info{% endif %}">
                            VCP ({{ vcp_count }})
                        </a>
                        <a href="?filter=stage2" class="btn btn-{% if current_filter == 'stage2' %}warning{% else %}outline-warning{% endif %}">
                            Stage 2 ({{ stage2_count }})
                        </a>
                        <a href="?filter=stage2_vcp" class="btn btn-{% if current_filter == 'stage2_vcp' %}danger{% else %}outline-danger{% endif %}">
                            Best Setups ({{ stage2_vcp_count }})
                        </a>
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            Sort By
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="?filter={{ current_filter }}&sort=-relative_strength">Relative Strength (High to Low)</a></li>
                            <li><a class="dropdown-item" href="?filter={{ current_filter }}&sort=-vcp_score">VCP Score (High to Low)</a></li>
                            <li><a class="dropdown-item" href="?filter={{ current_filter }}&sort=symbol">Symbol (A-Z)</a></li>
                            <li><a class="dropdown-item" href="?filter={{ current_filter }}&sort=-close_price">Price (High to Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body table-container">
                {% render_table table 'django_tables2/bootstrap5.html' %}
            </div>
        </div>

        <div class="mt-3">
            <p class="text-muted">
                <strong>Legend:</strong> 
                RS = Relative Strength (70+ is strong) | 
                VCP = Volatility Contraction Pattern detected | 
                Passes = Meets all Minervini criteria | 
                Stage: 1=Basing, 2=Advancing, 3=Topping, 4=Declining
            </p>
        </div>

    {% else %}
        <div class="alert alert-warning">
            <h4>No Data Available</h4>
            <p>Run the analysis scripts to populate the database:</p>
            <pre class="bg-dark text-white p-3 rounded">
cd scripts
python download_stock_data.py
python minervini.py
            </pre>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Check watchlist status for all visible stocks
    const buttons = document.querySelectorAll('.watchlist-toggle');
    const symbols = Array.from(buttons).map(btn => btn.dataset.symbol);
    
    // Check each symbol's watchlist status
    for (const symbol of symbols) {
        try {
            const response = await fetch(`/api/watchlist/check/${symbol}/`);
            const data = await response.json();
            
            const button = document.querySelector(`.watchlist-toggle[data-symbol="${symbol}"]`);
            if (button) {
                const icon = button.querySelector('.watchlist-icon');
                if (data.in_watchlist) {
                    icon.textContent = 'â˜…';
                    button.classList.remove('btn-outline-warning');
                    button.classList.add('btn-warning');
                    button.title = 'Remove from Watchlist';
                }
            }
        } catch (error) {
            console.error(`Error checking watchlist status for ${symbol}:`, error);
        }
    }
    
    // Toggle watchlist
    buttons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            const symbol = this.dataset.symbol;
            const icon = this.querySelector('.watchlist-icon');
            const isInWatchlist = icon.textContent === 'â˜…';
            const csrfToken = getCookie('csrftoken');
            
            try {
                const url = isInWatchlist 
                    ? `/api/watchlist/remove/${symbol}/` 
                    : `/api/watchlist/add/${symbol}/`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Toggle icon and button style
                    if (isInWatchlist) {
                        icon.textContent = 'â˜†';
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-outline-warning');
                        this.title = 'Add to Watchlist';
                    } else {
                        icon.textContent = 'â˜…';
                        this.classList.remove('btn-outline-warning');
                        this.classList.add('btn-warning');
                        this.title = 'Remove from Watchlist';
                    }
                }
            } catch (error) {
                console.error('Error toggling watchlist:', error);
                alert('Error updating watchlist');
            }
        });
    });
});
</script>
{% endblock %}
